{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm rounded-3 p-4">
        <h2 class="mb-4">{% if babel %}Editar Babel{% else %}Crear Babel{% endif %}</h2>

        <form method="get" class="mb-4">
            <div class="row g-3">
                <!-- Búsqueda -->
                <div class="col-md-4">
                    <input type="text" name="search" class="form-control" placeholder="Buscar por título o autor" value="{{ search_query }}">
                </div>

                <!-- Clasificación -->
                <div class="col-md-3">
                    <select id="classification-filter" name="classification" class="form-select">
                        <option value="">Todas las clasificaciones</option>
                        {% for classification in user_classifications %}
                            <option value="{{ classification.id }}" {% if selected_classification_id == classification.id|stringformat:"s" %}selected{% endif %}>
                                {{ classification.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Género -->
                <div class="col-md-3">
                    <select id="genre-filter" name="genre" class="form-select">
                        <option value="">Todos los géneros</option>
                        {% for genre in user_genres %}
                            {% if not selected_classification_id or genre.classification.id|stringformat:"s" == selected_classification_id %}
                                <option value="{{ genre.id }}" {% if selected_genre_id == genre.id|stringformat:"s" %}selected{% endif %}>
                                    {{ genre.name }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-outline-primary">Filtrar</button>
                </div>
            </div>
        </form>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Nombre del Babel -->
            <div class="mb-3">
                <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">Nombre de Babel</label>
                {{ form.name }}
            </div>

            <!-- Descripción del Babel (opcional) -->
            <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">Descripción (opcional)</label>
                {{ form.description }}
            </div>

            <div class="row mt-4">
                <!-- Libros disponibles -->
                <div class="col-md-6">
                    <h4>Libros disponibles</h4>
                    <ul id="available-books" class="list-unstyled">
                        {% for book in books %}
                            {% comment %} Si el libro ya está en babel, no lo mostramos en disponibles {% endcomment %}
                            {% if not babel or book not in babel.books.all %}
                            <li class="mb-2 d-flex align-items-center" data-id="{{ book.id }}" data-classification="{{ book.classification.id }}" data-genre="{{ book.genre.id }}">
                                {% if book.image %}
                                    <img src="{{ book.image.url }}" alt="{{ book.title }}" class="img-thumbnail me-2" style="width: 60px; height: 60px; object-fit: cover;">
                                {% endif %}
                                <span>{{ book.title }} - {{ book.author.first_name }} {{ book.author.last_name }}</span>
                                <button type="button" class="btn btn-sm btn-success ms-2 add-book">+</button>
                            </li>
                            {% endif %}
                        {% empty %}
                            <li>No hay libros disponibles</li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Libros seleccionados -->
                <div class="col-md-6">
                    <h4>Libros seleccionados</h4>
                    <ul id="selected-books" class="list-unstyled">
                        {% if babel and babel.books.all %}
                            {% for book in babel.books.all %}
                                <li class="mb-2 d-flex align-items-center" data-id="{{ book.id }}">
                                    {% if book.image %}
                                        <img src="{{ book.image.url }}" alt="{{ book.title }}" class="img-thumbnail me-2" style="width: 60px; height: 60px; object-fit: cover;">
                                    {% endif %}
                                    <span>{{ book.title }} - {{ book.author.first_name }} {{ book.author.last_name }}</span>
                                    <button type="button" class="btn btn-sm btn-danger ms-2 remove-book">x</button>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Campo oculto para guardar los libros seleccionados -->
            <input type="hidden" name="books" id="id_books" 
                value="{% if babel_books_ids %}{{ babel_books_ids|join:',' }}{% endif %}">
            <button type="submit" class="btn btn-primary mt-4 w-100">
                {% if babel %}Actualizar Babel{% else %}Crear Babel{% endif %}
            </button>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const availableList = document.getElementById("available-books");
    const selectedList = document.getElementById("selected-books");
    const booksInput = document.getElementById("id_books");

    // Delegación para botón "+"
    availableList.addEventListener("click", function (e) {
        if (e.target.classList.contains("add-book")) {
            const li = e.target.closest("li");
            const clone = li.cloneNode(true);

            const btn = clone.querySelector("button");
            btn.textContent = "x";
            btn.classList.remove("btn-success", "add-book");
            btn.classList.add("btn-danger", "remove-book");

            selectedList.appendChild(clone);
            li.remove();
        }
    });

    // Delegación para botón "x"
    selectedList.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-book")) {
            const li = e.target.closest("li");
            const clone = li.cloneNode(true);

            const btn = clone.querySelector("button");
            btn.textContent = "+";
            btn.classList.remove("btn-danger", "remove-book");
            btn.classList.add("btn-success", "add-book");

            availableList.appendChild(clone);
            li.remove();
        }
    });

    // Guardar IDs en hidden antes de enviar
    document.querySelector("form[method='post']").addEventListener("submit", function () {
        const ids = [];
        selectedList.querySelectorAll("li").forEach(li => {
            ids.push(li.dataset.id);
        });
        booksInput.value = ids.join(",");
    });

    // Filtro dinámico de géneros según la clasificación seleccionada
    const classificationFilter = document.getElementById("classification-filter");
    const genreFilter = document.getElementById("genre-filter");
    const allGenres = Array.from(genreFilter.querySelectorAll("option"));

    classificationFilter.addEventListener("change", function () {
        const selectedClassification = this.value;
        genreFilter.innerHTML = '<option value="">Todos los géneros</option>';
        allGenres.forEach(opt => {
            if (!selectedClassification || opt.dataset.classification == selectedClassification) {
                genreFilter.appendChild(opt);
            }
        });

        // Filtrar libros visibles
        filterBooks();
    });

    genreFilter.addEventListener("change", filterBooks);

    function filterBooks() {
        const selectedClassification = classificationFilter.value;
        const selectedGenre = genreFilter.value;
        availableList.querySelectorAll("li").forEach(li => {
            const liClassification = li.dataset.classification;
            const liGenre = li.dataset.genre;
            li.style.display =
                (!selectedClassification || liClassification === selectedClassification) &&
                (!selectedGenre || liGenre === selectedGenre)
                ? "flex" : "none";
        });
    }

});
</script>
{% endblock %}
