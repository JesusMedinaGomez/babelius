{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1 class="mb-4 text-center">{{ book.title }}</h1>

<div class="pdf-container d-flex justify-content-center mb-3" style="position:relative;">
    <canvas id="pdf-render" style="border:1px solid #ccc; max-width:100%; height:auto;"></canvas>
</div>

<div class="pdf-controls d-flex justify-content-center align-items-center gap-2 mb-3">
    <button id="prev-page" class="btn btn-outline-primary">⬅️ Anterior</button>
    <span>Página: <span id="page-num"></span> / <span id="page-count"></span></span>
    <button id="next-page" class="btn btn-outline-primary">Siguiente ➡️</button>
    <button id="fullscreen-btn" class="btn btn-outline-secondary">📺 Pantalla completa</button>
    <button id="finish-reading" class="btn btn-success">✅ Terminar lectura</button>
</div>

<!-- Barra de progreso de lectura -->
{% if book.page_count %}
<div class="progress mt-3" style="height:25px;">
    <div id="progressBar" class="progress-bar bg-info" role="progressbar"
         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        0%
    </div>
</div>
<p class="text-center mt-2"><strong>Páginas leídas:</strong> <span id="current-page-display">{{ last_page|default:0 }}</span> / {{ book.page_count }}</p>
{% endif %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
// ================== Variables ==================
const url = "{% if book.pdf_file %}{{ book.pdf_file.url }}{% endif %}";
let pageNum = parseInt("{{ last_page|default:1 }}");
let pdfDoc = null;
let pageRendering = false;
let pageNumPending = null;
let scale = 1.5;

const canvas = document.getElementById('pdf-render');
const ctx = canvas.getContext('2d');
const progressBar = document.getElementById('progressBar');
const currentPageDisplay = document.getElementById('current-page-display');

// ================== Función render ==================
function renderPage(num){
    pageRendering = true;
    pdfDoc.getPage(num).then(page=>{
        const viewport = page.getViewport({scale: scale});
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        page.render({canvasContext: ctx, viewport: viewport}).promise.then(()=>{
            pageRendering = false;
            document.getElementById('page-num').textContent = num;
            updateProgressBar();
            if(pageNumPending!==null){ renderPage(pageNumPending); pageNumPending=null; }
        });
    });
}

function queueRenderPage(num){
    if(pageRendering){ pageNumPending = num; } else { renderPage(num); }
}

// ================== Actualizar barra de progreso ==================
function updateProgressBar(){
    const totalPages = {{ book.page_count|default:0 }};
    const percent = totalPages > 0 ? Math.round((pageNum / totalPages) * 100) : 0;
    if(progressBar){
        progressBar.style.width = percent + "%";
        progressBar.innerText = percent + "%";
        progressBar.setAttribute('aria-valuenow', percent);
    }
    if(currentPageDisplay){
        currentPageDisplay.textContent = pageNum;
    }
}

// ================== Botones ==================
document.getElementById('prev-page').addEventListener('click', ()=>{
    if(pageNum<=1) return;
    pageNum--;
    queueRenderPage(pageNum);
});
document.getElementById('next-page').addEventListener('click', ()=>{
    if(pageNum>=pdfDoc.numPages) return;
    pageNum++;
    queueRenderPage(pageNum);
});

// ================== Fullscreen ==================
document.getElementById('fullscreen-btn').addEventListener('click', ()=>{
    if(canvas.requestFullscreen){ canvas.requestFullscreen(); }
    else if(canvas.webkitRequestFullscreen){ canvas.webkitRequestFullscreen(); }
    else if(canvas.msRequestFullscreen){ canvas.msRequestFullscreen(); }
});

// ================== Guardar última página ==================
function saveLastPage(num, callback=null){
    fetch("{% url 'save_last_page' %}", {
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "X-CSRFToken":"{{ csrf_token }}"
        },
        body: JSON.stringify({"book_id":"{{ book.id }}","last_page":num})
    }).finally(()=>{ if(callback) callback(); });
}

// ================== Terminar lectura ==================
document.getElementById('finish-reading').addEventListener('click', ()=>{
    saveLastPage(pageNum, ()=>{ window.location.href = "{% url 'read_books' %}"; });
});

// ================== Atajos teclado ==================
document.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft'){ document.getElementById('prev-page').click(); }
    else if(e.key==='ArrowRight'){ document.getElementById('next-page').click(); }
    else if(e.key.toLowerCase()==='f'){ document.getElementById('fullscreen-btn').click(); }
});

// ================== Zoom con scroll ==================
canvas.addEventListener('wheel', e=>{
    e.preventDefault();
    if(document.fullscreenElement) return;
    const delta = e.deltaY < 0 ? 0.1 : -0.1;
    scale = Math.min(3, Math.max(0.5, scale + delta));
    queueRenderPage(pageNum);
},{passive:false});

// ================== Cargar PDF ==================
pdfjsLib.getDocument(url).promise.then(pdf=>{
    pdfDoc = pdf;
    document.getElementById('page-count').textContent = pdfDoc.numPages;
    if(pageNum>pdfDoc.numPages) pageNum = pdfDoc.numPages;
    renderPage(pageNum);
});
</script>
{% endblock %}
